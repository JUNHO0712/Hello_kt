# ===========================================
# 1. ì‹œê°„ ë™ê¸°í™” (ëª¨ë“  ì„œë²„)
# ===========================================
- name: Configure Time Synchronization
  hosts: all
  become: yes
  tags: [chrony, time-sync]
  roles:
    - chrony

# ===========================================
# 2. K3s Master ì„¤ì¹˜
# ===========================================
- name: Install K3s Master
  hosts: master
  become: yes
  tags: [k3s, k3s-master]
  roles:
    - k3s_master

# ===========================================
# 3. K3s Worker ì„¤ì¹˜
# ===========================================
- name: Install K3s Workers
  hosts: worker
  become: yes
  tags: [k3s, k3s-worker]
  roles:
    - k3s_worker

# ===========================================
# 4. ëª¨ë‹ˆí„°ë§ - Node Exporter (K3s ë…¸ë“œ)
# ===========================================
- name: Install Node Exporter on K3s Nodes
  hosts: all:!monitoring   # -> master, worker monitoring 
  become: yes
  tags: [monitoring, node-exporter]
  roles:
    - node_exporter

# ===========================================
# 5. ëª¨ë‹ˆí„°ë§ - Full Stack (ëª¨ë‹ˆí„°ë§ ì„œë²„)
# ===========================================
- name: Install Monitoring Stack (Prometheus + Grafana)
  hosts: monitoring
  become: yes
  tags: [monitoring, monitoring-stack]
  roles:
    - monitoring
# ===========================================
# 6. ëª¨ë‹ˆí„°ë§ - Kube-state-metrics (K3s í´ëŸ¬ìŠ¤í„° ë‚´ë¶€)
# ===========================================
- name: Deploy Kube-state-metrics to K3s Cluster
  hosts: master
  become: yes
  tags: [monitoring, ksm]
  roles:
    - kube_state_metrics
# ===========================================
# 6-1. Loki ë°°í¬ (K3s í´ëŸ¬ìŠ¤í„° ë‚´ë¶€)
# ===========================================
- name: Deploy Loki to K3s Cluster
  hosts: master
  become: yes
  tags: [monitoring, loki]
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  roles:
    - loki

# ===========================================
# 7. í´ëŸ¬ìŠ¤í„° ê²€ì¦ ë° í…ŒìŠ¤íŠ¸
# ===========================================
- name: Verify K3s Cluster
  hosts: master
  become: yes
  tags: [verify]
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml  # kubectlì´ ì–´ë–¤ kubeconfigë¥¼ ì°¸ì¡°í• ì§€ ì§€ì •
    
  tasks:
    - name: Wait for all nodes to be ready # ë…¸ë“œê°€ 3ê°œ (1ê°œ master + 2ê°œ worker) ëª¨ë‘ Ready ìƒíƒœê°€ ë  ë•Œê¹Œì§€ ëŒ€ê¸°
      shell: |
        kubectl get nodes --no-headers | grep -v NotReady | wc -l
      register: ready_nodes
      until: ready_nodes.stdout | int == 3
      retries: 20
      delay: 10
      changed_when: false

    - name: Get cluster status
      command: kubectl get nodes -o wide
      register: cluster_status
      changed_when: false

    - name: Display cluster status
      debug:
        msg: "{{ cluster_status.stdout_lines }}"

    - name: Get pods in all namespaces
      command: kubectl get pods -A
      register: all_pods
      changed_when: false

    - name: Display all pods
      debug:
        msg: "{{ all_pods.stdout_lines }}"

    - name: Run deployment test (Nginx)  # ì‹¤ì œ ì›Œí¬ë¡œë“œë¥¼ ë°°í¬/ëŒ€ê¸°í•˜ì—¬ "í´ëŸ¬ìŠ¤í„°ê°€ ì§„ì§œë¡œ ë™ì‘"í•˜ëŠ”ì§€ ê²€ì¦
      shell: |
        kubectl create deployment nginx-test --image=nginx:latest --replicas=2
        kubectl wait --for=condition=available --timeout=60s deployment/nginx-test
      register: test_deploy
      changed_when: false
      ignore_errors: yes    # í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨í•´ë„ ì „ì²´ í”Œë ˆì´ë¶ì´ ë°”ë¡œ ì£½ì§€ ì•Šê²Œ(ë””ë²„ê¹… í¸ì˜)

    - name: Clean up test deployment # í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí–ˆì„ ë•Œë§Œ ì‚­ì œ
      command: kubectl delete deployment nginx-test
      when: test_deploy is success
      changed_when: false

    # í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•˜ëŠ” ê²½ìš° nginx-testê°€ ë‚¨ì„ ìˆ˜ ìˆì–´ì„œ í•­ìƒ ì‹¤í–‰í•˜ë„ë¡
    #- name: Clean up test deployment (always try)
     # command: kubectl delete deployment nginx-test --ignore-not-found=true
     # changed_when: false

    - name: Success message
      debug:
        msg: "K3s cluster is fully operational with {{ ready_nodes.stdout }} nodes! (1 Master, 2 Workers)"

# ===========================================
# 8. ëª¨ë‹ˆí„°ë§ ê²€ì¦
# ===========================================
- name: Verify Monitoring Stack
  hosts: monitoring
  become: yes
  tags: [verify, verify-monitoring]
  tasks:
    - name: Wait for Prometheus to be ready
      uri:
        url: http://localhost:9090/-/ready
        status_code: 200
      register: prometheus_ready
      until: prometheus_ready.status == 200
      retries: 10
      delay: 5
      ignore_errors: yes

    - name: Wait for Grafana to be ready
      uri:
        url: http://localhost:3000/api/health
        status_code: 200
      register: grafana_ready
      until: grafana_ready.status == 200
      retries: 10
      delay: 5
      ignore_errors: yes

    - name: Check Node Exporter on monitoring server
      uri:
        url: http://localhost:9100/metrics
        status_code: 200
      register: node_exporter_ready
      ignore_errors: yes

    # --- cAdvisor ê²€ì¦ ì¶”ê°€ ---
    - name: Wait for cAdvisor to be ready
      uri:
        url: http://localhost:8080/metrics
        status_code: 200
      register: cadvisor_ready
      until: cadvisor_ready.status == 200
      retries: 10
      delay: 5
      ignore_errors: yes

    - name: Get monitoring stack status
      command: docker compose ps
      args:
        chdir: /opt/monitoring
      register: monitoring_status
      changed_when: false

    - name: Display monitoring status
      debug:
        msg: "{{ monitoring_status.stdout_lines }}"

    - name: Get public IP for access URLs
      set_fact:
        monitoring_public_ip: "{{ ansible_host }}"
    # --- KSM ê²€ì¦  ì¶”ê°€ ---
    - name: Check Kube-state-metrics on Worker Nodes
      uri:
        url: "http://{{ item }}:30081/metrics"
        status_code: 200
      loop: "{{ groups['worker'] }}"  # ì¸ë²¤í† ë¦¬ì˜ worker ê·¸ë£¹ IPë“¤ ìˆœíšŒ
      register: ksm_verify
      ignore_errors: yes

    - name: Success message
      debug:
        msg: |
          âœ… Monitoring Stack is ready!
          
          ğŸ“Š Access URLs:
          - Grafana:    http://{{ monitoring_public_ip }}:3000 (admin/admin)
          - Prometheus: http://{{ monitoring_public_ip }}:9090
          - Node Export: http://{{ monitoring_public_ip }}:9100/metrics
          - cAdvisor:   http://{{ ansible_host }}:8080
          - KSM:        http://{{ groups['worker'][0] }}:30081/metrics

# ===========================================
# 9. Lunch App ë°°í¬ (GHCR â†’ K3s)
# ===========================================
- name: Deploy Lunch App to K3s
  hosts: master
  become: yes
  tags: [app, deploy]
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml # app_deploy roleì—ì„œë„ kubectlì´ í´ëŸ¬ìŠ¤í„°ë¥¼ ì •í™•íˆ ë³´ë„ë¡ í•¨
  roles:
    - app_deploy  # í…œí”Œë¦¿ ë Œë”ë§ -> kubecl apply -> rollout í™•ì¸

# ===========================================
# ë§¤ë‰´ì–¼ ë° íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ê°€ì´ë“œ
# ===========================================
# === â–  ì „ì²´ ì„¤ì¹˜ ===
# ansible-playbook -i inventory/aws.ini site.yml
#
# === â–  ë‹¨ê³„ë³„ ì„¤ì¹˜ ===
# Step 1: ì‹œê°„ ë™ê¸°í™” (ì „ì²´ 4ëŒ€)
# ansible-playbook -i inventory/aws.ini site.yml --tags chrony
#
# Step 2: Master ì„¤ì¹˜ (1ëŒ€)
# ansible-playbook -i inventory/aws.ini site.yml --tags k3s-master
#
# Step 3: Worker ì„¤ì¹˜ (2ëŒ€)
# ansible-playbook -i inventory/aws.ini site.yml --tags k3s-worker
#
# Step 4: K3s ë…¸ë“œì— Node Exporter ì„¤ì¹˜ (3ëŒ€: Master + Workers)
# ansible-playbook -i inventory/aws.ini site.yml --tags node-exporter
#
# Step 5: ëª¨ë‹ˆí„°ë§ ì„œë²„ì— ì „ì²´ ìŠ¤íƒ ì„¤ì¹˜ (1ëŒ€)
# ansible-playbook -i inventory/aws.ini site.yml --tags monitoring-stack
#
# Step 6: í´ëŸ¬ìŠ¤í„° ìƒíƒœ ê²€ì¦
# ansible-playbook -i inventory/aws.ini site.yml --tags verify
#
# Step 7: ëª¨ë‹ˆí„°ë§ ìŠ¤íƒ ê²€ì¦
# ansible-playbook -i inventory/aws.ini site.yml --tags verify-monitoring
#
# === â–  ëª¨ë‹ˆí„°ë§ë§Œ ì„¤ì¹˜ (K3s ê±´ë“œë¦¬ì§€ ì•ŠìŒ) ===
# ansible-playbook -i inventory/aws.ini site.yml --tags monitoring
#
# === â–  íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ===
# íŠ¹ì • Workerë§Œ ì¬ì„¤ì¹˜ (ì˜ˆ: IPê°€ 10.0.3.10 ì¸ ê²½ìš°)
# ansible-playbook -i inventory/aws.ini site.yml --tags k3s-worker --limit 10.0.3.10
#
# ëª¨ë‹ˆí„°ë§ ì„œë²„ë§Œ ì¬ì„¤ì¹˜
# ansible-playbook -i inventory/aws.ini site.yml --tags monitoring-stack
#
# íŠ¹ì • Workerì˜ Node Exporterë§Œ ì¬ì„¤ì¹˜
# ansible-playbook -i inventory/aws.ini site.yml --tags node-exporter --limit 10.0.3.10
#
# === â–  ëª¨ë‹ˆí„°ë§ ì ‘ì† ì •ë³´ í™•ì¸ ===
# ansible monitoring -i inventory/aws.ini -m debug -a "var=ansible_host"
#
# === â–  Kube-state-metrics (KSM) ê´€ë ¨ ===
#
# 1) KSMë§Œ ì¬ë°°í¬ (ì„¤ì • ë³€ê²½ ì‹œ)
# ansible-playbook -i inventory/aws.ini site.yml --tags ksm
#
# 2) KSM ì¬ë°°í¬ ë° ë™ì‘ ì¦‰ì‹œ ê²€ì¦
# ansible-playbook -i inventory/aws.ini site.yml --tags ksm,verify-monitoring
#
# 3) KSM í¬íŠ¸ ì¶©ëŒ í™•ì¸ (Worker ë…¸ë“œì—ì„œ ì‹¤í–‰)
# netstat -tulpn | grep 30081
#
# === â–  Loki (ë¡œê·¸ ëª¨ë‹ˆí„°ë§) ê´€ë ¨ ===
#
# 1) Lokië§Œ ì¬ë°°í¬ (ì„¤ì • ë³€ê²½ ë˜ëŠ” ì¬ì„¤ì¹˜ ì‹œ)
# ansible-playbook -i inventory/aws.ini site.yml --tags loki
#
# 2) Loki ë°°í¬ ë° K3s ë‚´ Pod ìƒíƒœ ì¦‰ì‹œ í™•ì¸
# ansible-playbook -i inventory/aws.ini site.yml --tags loki --limit master
# (Master ë…¸ë“œì—ì„œ kubectlì„ í†µí•´ ë°°í¬ë˜ë¯€ë¡œ master ê·¸ë£¹ìœ¼ë¡œ í•œì • ê°€ëŠ¥)
#
# 3) Loki ì„œë¹„ìŠ¤ í¬íŠ¸ ë° ì ‘ì† í™•ì¸ (Master ë…¸ë“œ ì‹¤í–‰)
# kubectl get svc -n monitoring | grep loki
#
# 4) Loki ë¡œê·¸ ìˆ˜ì§‘ ìƒíƒœ í™•ì¸ (Grafana Explore íƒ­ì—ì„œ í…ŒìŠ¤íŠ¸)
# Grafana ì ‘ì† í›„ Data Sourceì— http://loki:3100 (ë‚´ë¶€ DNS) ë˜ëŠ” í•´ë‹¹ IP ë“±ë¡ í™•ì¸
#


