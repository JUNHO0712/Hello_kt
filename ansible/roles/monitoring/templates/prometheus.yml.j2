global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'k3s-production'
    monitor: 'main-monitoring'

scrape_configs:
  # 1. Prometheus 자기 자신 모니터링
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # 2. AWS EC2 자동 탐지 (Node Exporter용)
  - job_name: 'ec2-nodes'
    ec2_sd_configs:
      - region: ap-northeast-2
        port: 9100
    relabel_configs:
      # AWS Name 태그를 인스턴스 이름으로 사용
      - source_labels: [__meta_ec2_tag_Name]
        target_label: instance
      # Role 태그가 master, worker, monitoring인 것만 수집
      - source_labels: [__meta_ec2_tag_Role]
        regex: (master|worker|monitoring)
        action: keep

  # 3. AWS EC2 자동 탐지 (cAdvisor - 컨테이너 모니터링용)
  - job_name: 'ec2-cadvisor'
    ec2_sd_configs:
      - region: ap-northeast-2
        port: 8080
    relabel_configs:
      - source_labels: [__meta_ec2_tag_Name]
        target_label: instance
      - source_labels: [__meta_ec2_tag_Role]
        regex: (master|worker|monitoring)
        action: keep

  # 4. AWS EC2 자동 탐지 (Kube-state-metrics 모니터링용)
  - job_name: 'ec2-ksm'
    ec2_sd_configs:
      - region: ap-northeast-2
        port: 30081  # KSM NodePort 번호
    relabel_configs:
      - source_labels: [__meta_ec2_tag_Name]
        target_label: instance
      # KSM은 보통 master나 worker 노드에서 실행되므로 해당 노드들만 유지
      - source_labels: [__meta_ec2_tag_Role]
        regex: (master|worker)
        action: keep

