---
# 1. 마스터 정보(Token, IP) 가져오기 (run_once + delegate_to)
- name: Fetch token from Master (once)
  command: cat /var/lib/rancher/k3s/server/node-token
  register: fetched_token
  delegate_to: "{{ groups['master'][0] }}"
  become: true
  changed_when: false
  run_once: true

- name: Set K3s token and Master IP
  set_fact:
    k3s_master_token: "{{ fetched_token.stdout }}"
    k3s_master_endpoint: "{{ groups['master'][0] }}"


- name: Display Worker join information
  debug:
    msg: "Worker {{ inventory_hostname }} is joining K3s Master at https://{{ k3s_master_endpoint }}:6443"

# 2. 시스템 사전 준비
- name: Disable swap permanently (Required for K3s)
  shell: |
    swapoff -a
    sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab
  changed_when: false

- name: Load required kernel modules
  community.general.modprobe:
    name: "{{ item }}"
    state: present
  loop: [overlay, br_netfilter]

- name: Configure sysctl for K8s networking
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    sysctl_file: /etc/sysctl.d/k3s.conf
    reload: yes
  loop:
    - { key: 'net.bridge.bridge-nf-call-iptables', value: '1' }
    - { key: 'net.ipv4.ip_forward', value: '1' }

# 3. K3s Agent 설치 준비
- name: Check if K3s agent is already installed
  stat:
    path: /usr/local/bin/k3s-agent
  register: k3s_agent_installed

- name: Download K3s installation script
  get_url:
    url: "{{ k3s_install_url | default('https://get.k3s.io') }}"
    dest: /tmp/k3s-install.sh
    mode: '0755'
  when: not k3s_agent_installed.stat.exists
  retries: 3
  delay: 10

# 4. K3s Agent(Worker) 설치 실행
- name: Install K3s Agent on Worker node
  shell: |
    INSTALL_K3S_VERSION="{{ k3s_version }}" \
    K3S_URL="https://{{ k3s_master_endpoint }}:6443" \
    K3S_TOKEN="{{ k3s_master_token }}" \
    sh /tmp/k3s-install.sh agent {{ k3s_agent_options | default([]) | join(' ') }}
  when: not k3s_agent_installed.stat.exists
  register: install_worker
  until: install_worker is succeeded
  retries: 3
  delay: 15
  notify: Restart k3s-agent

# 5. 설치 검증 및 서비스 확인
- name: Wait for Kubelet config to be generated
  wait_for:
    path: /var/lib/rancher/k3s/agent/kubelet.kubeconfig
    timeout: 120

- name: Wait for kubelet to be ready (Port 10250)
  wait_for:
    port: 10250
    delay: 5
    timeout: 120
    host: "{{ ansible_default_ipv4.address }}"

- name: Ensure K3s Agent service is running
  systemd:
    name: k3s-agent
    state: started
    enabled: yes

# 6. 마무리
- name: Clean up installation script
  file:
    path: /tmp/k3s-install.sh
    state: absent
  changed_when: false

- name: Display Worker installation complete
  debug:
    msg: "Worker node {{ inventory_hostname }} successfully joined the cluster!"